# LinguaLens AI Agent Instructions

## Project Overview
LinguaLens is a **Next.js 16 (App Router) multilingual translation assistant** using AI streaming APIs. It provides context-aware translation with scene-based prompting, supporting 12 locales with full i18n routing via `next-intl`.

**Core Architecture:**
- **Frontend:** Next.js 16 + React 19 + ShadCN UI + Tailwind CSS
- **AI Integration:** AI SDK (`ai` package) with Google Gemini and OpenAI providers via streaming
- **State:** Zustand for chat history; localStorage for persistence (scenes, sessions, settings)
- **i18n:** `next-intl` with locale-based routing (`app/[locale]/*`), 12 languages in `messages/*.json`

## Critical Concepts

### 1. Scene-Based Translation System
Translation behavior is controlled by **scenes** ([lib/scenes.ts](lib/scenes.ts)), not generic prompts.
- Default scenes live in `SCENES` array; custom scenes stored in `localStorage` under key `"customScenes"`
- Each scene has: `name` (Chinese), `name_en`, `description`, `prompt` (system instructions)
- Scene prompt **overrides** default translation logic in the API route
- **Scene Selection Flow:** `SceneSelector` → `localStorage.setItem("selectedScene", name)` → passed to `/api/chat` as `scene` param

**When editing scenes:**
- Always preserve the scene structure (name, name_en, description, prompt fields)
- Scene prompts should specify output language rules explicitly if needed (see "讨论/需求对齐邀请" example)
- Default fallback translation: Non-Chinese → Chinese; Chinese → English (unless scene overrides)

### 2. Internationalization (i18n) Architecture
- **Routing:** All user-facing routes are under `app/[locale]/*`. Valid locales defined in [i18n/routing.ts](i18n/routing.ts)
- **Translation Keys:** UI strings come from `messages/{locale}.json`. Use `useTranslations('namespace')` hook
- **Adding New Locales:**
  1. Add locale code to `routing.locales` in [i18n/routing.ts](i18n/routing.ts)
  2. Create `messages/{locale}.json` (copy structure from [messages/en.json](messages/en.json))
  3. Update `getLanguageNameByLocale()` map in [app/api/chat/route.ts](app/api/chat/route.ts)
  4. Add flag/name to [components/language-switcher.tsx](components/language-switcher.tsx)

### 3. Chat History & Session Management
- **Storage:** Sessions persist in `localStorage` with key `"lingualens-chat-history"` (max 30 days)
- **Session ID:** Format `session_{timestamp}_{random}` (see [hooks/use-chat-history.ts](hooks/use-chat-history.ts))
- **State Management:** 
  - `useChatHistory` hook provides CRUD for sessions/messages
  - `ChatProvider` context ([components/chat-provider.tsx](components/chat-provider.tsx)) manages loaded session state for UI
  - Sessions only saved when `messages.length > 0`

**Session Structure:**
```typescript
interface ChatSession {
  id: string
  date: string  // ISO date (YYYY-MM-DD)
  timestamp: number
  messages: HistoryMessage[]
  scene: string  // Scene name
  model: string
}
```

### 4. AI Streaming Pattern
- **Route:** [app/api/chat/route.ts](app/api/chat/route.ts) uses `ai` SDK's `streamText()`
- **Model Selection:** Uses [lib/models.ts](lib/models.ts) config; provider resolved by `getModelProvider()` function
- **System Prompt:** Generated by `createSystemInstructions(scene, locale)` - combines scene prompt + locale context
- **Reasoning Mode:** OpenAI models support `thinking` mode (set via request body param)
- **Message Trimming:** Only last 4 messages sent to API (cost optimization)

## Development Workflows

### Running Locally
```bash
pnpm install        # Install dependencies
pnpm dev           # Start dev server (uses Turbopack)
```
Access at `http://localhost:3000` → auto-redirects to `/en` (or browser locale)

### Environment Variables
Required keys in `.env.local` (see [sample.env](sample.env)):
- `GOOGLE_GENERATIVE_AI_API_KEY` - Google Gemini API
- `OPENAI_API_KEY` - OpenAI models
- `GROQ_API_KEY` / `MISTRAL_API_KEY` - Alternative providers
- `NEXT_PUBLIC_GA_ID` - Google Analytics (optional)

### Build & Deploy
```bash
pnpm build         # Production build
pnpm start         # Start production server
```
**Docker:** Use included [Dockerfile](Dockerfile) (multi-stage Node 22 Alpine). Ports: internal 3000, configurable external.

## Code Conventions

### File Organization
- **API Routes:** `app/api/{endpoint}/route.ts` (Next.js 15 convention)
- **Locale Pages:** `app/[locale]/{route}/page.tsx` (i18n structure)
- **Shared UI:** `components/ui/*` (ShadCN components - don't edit directly)
- **Custom Components:** `components/*.tsx` (app-specific logic)
- **Hooks:** `hooks/use-*.ts` (client-side only, always "use client")
- **Utils:** `lib/*.ts` (shared logic, types, constants)

### TypeScript Patterns
- **Strict Mode:** Enabled. Always type props and function returns
- **Import Aliases:** Use `@/*` for workspace root (see [tsconfig.json](tsconfig.json))
- **UI Messages:** Type as `UIMessage` from `ai` for chat components
- **Scene Types:** Import `Scene` from [lib/scenes.ts](lib/scenes.ts)

### localStorage Keys (Critical - Do Not Change)
- `"customScenes"` - User-created translation scenes
- `"lingualens-chat-history"` - Chat session history
- `"selectedModel"` - Last used AI model
- `"selectedScene"` - Last selected scene name (string)

### Client/Server Boundaries
- All components using hooks/localStorage MUST have `"use client"` directive
- API routes are server-side by default
- Use `useLocale()` hook (not `params`) in client components for locale
- `next-intl` provides separate hooks for client vs server: `useTranslations` (client) vs `getTranslations` (server)

## AI Agent Guidance

### When Adding Features
1. **Check localStorage keys** - Don't break existing persistence
2. **Update scene prompts in [lib/scenes.ts](lib/scenes.ts)** if changing translation behavior
3. **Add i18n keys to ALL locale files** (`messages/*.json`) for new UI strings
4. **Maintain API contract:** `/api/chat` expects `{ messages, model, scene, locale, thinking? }`

### When Modifying Scenes
- Scene prompts are **instructions for the AI model**, not UI text
- Test with multiple locales - scene output language may vary by design
- Scene description is shown to users; keep it concise (1 sentence)
- Meeting/email scenes often specify fixed output language (e.g., always English)

### When Debugging
- **Chat not persisting?** Check `updateSessionMessages()` is called with non-empty messages
- **Wrong translation direction?** Verify `getLanguageNameByLocale()` includes the locale
- **Scene not applying?** Ensure `selectedScene` object (not just name) passed to useChat body
- **i18n missing?** Run `pnpm dev` to regenerate `.next/types` and check console for missing keys

### Common Pitfalls
- Don't import from `components/ui/chat` internals - use exported `Message` type only
- Scene state lives in component state AND localStorage - both must sync
- `loadedMessages` from `useChatContext` is for restoring sessions, not current chat state
- Don't modify `SCENES` array directly - use spread operator to combine with custom scenes

## Key Files Reference
- [lib/scenes.ts](lib/scenes.ts) - Scene definitions & prompts (core translation logic)
- [app/api/chat/route.ts](app/api/chat/route.ts) - AI streaming endpoint
- [components/translator-chat.tsx](components/translator-chat.tsx) - Main chat UI component
- [hooks/use-chat-history.ts](hooks/use-chat-history.ts) - Session persistence logic
- [i18n/routing.ts](i18n/routing.ts) - Locale configuration
- [lib/models.ts](lib/models.ts) - AI model definitions

## External Docs
- Next.js 16 App Router: https://nextjs.org/docs/app
- AI SDK (Vercel): https://sdk.vercel.ai/docs
- next-intl: https://next-intl-docs.vercel.app/
- ShadCN UI: https://ui.shadcn.com/
